# 04. Web Application Security
________________________________________
安全なウェブサイトの作り方 改訂第7版  
https://www.ipa.go.jp/security/vuln/websecurity.html

Webアプリにおける11の脆弱性の常識と対策  
https://www.atmarkit.co.jp/ait/articles/0909/01/news158.html

体系的に学ぶ 安全なWebアプリケーションの作り方 第2版 2刷  
https://www.sbcr.jp/products/4797393163.html  
(電子書籍は1刷。未改善正誤表あり)

________________________________________
## 1. 脆弱性のポイント
________________________________________
一覧

1. getパラメータは拡散する。第三者に見られたくない情報を載せない
    - referer、アクセスログ、ショルダーハック、リンクで漏洩する
    - セッションIDをURLに含めてはならない
2. リクエストは改ざんできる。サーバ側で管理するべき情報をリクエストから取得しない
    - プロキシツール。refererも改ざんできる
    - サーバ側で管理するべき情報の例
        - 個人情報（セッションで管理されるべき）
        - EC注文時の商品情報（毎回サーバ内で取得するべき）
        - 問い合わせページのメール送信先（サーバ側の値を利用すること）
        - ダウンロードファイルリンク等（別の利用者のファイルをできるようにしてはならない）
        - Referer（信用してはならない）
3. basic認証は利用禁止
    - base64でエンコードされた平文が送信されている
4. セッションidは予測不能にする
    - 予測可能だと別のセッションになり済ませてしまう
5. ログイン成功時にセッションidは再発行する
    - セッション固定化攻撃を防ぐため
6. セッションidのdomain属性は不要なら設定しない
    - domain属性は、サブドメイン間でcookieを共有したい場合にのみ使う
7. セッションidのsecure属性を有効にする（httpsのみ化）
    - 中間経路でhttpヘッダのセッションidが漏洩してしまう
8. セッションidのhttponly属性を有効にする（jsアクセス不可化）
    - jsからアクセス・改変されてしまうのを防ぐ
9. サーバ側のCookie応答仕様は取説を読む
    - 例：secure属性と応答時のset cookieヘッダがあるかどうかは無関係
    - 例：secure属性がないと、http送信時に平文送信する
    - 例：httpsとhttpで共有する。防ぐ手段はない
10. corsを許可しすぎないこと
    - corsはセキュリティリスクでもある
11. script要素のjsはドキュメントのオリジン扱いになる
    - これを応用したハックがjsonp
12. XSSを防ぐには、表示する内容をエスケープする
    - XSSは別名htmlインジェクション
    - 入力では完全には防げない。出力で対応する
    - 可能ならば全てのパラメータ表示箇所でエスケープするのが確実
    - コンテントは<&、属性は""で囲み<"&をエスケープ
    - phpならhtmlspecialchars($string, ENT_QUOTES, $charset)
13. SQLインジェクションを防ぐには、プレースホルダを利用する
    - プレースホルダにしないと、SQLインジェクションが発生してしまう
14. CSRFを防ぐには、CSRFトークンを採用すること
    - httpはどの画面からリクエストが送られたかを検証する仕組みがない
15. クリックジャッキングを防ぐには、X-Frame-Options: SAMEORIGIN
    - cssを駆使すると、iframeを透明した上で別のコンテンツを重ねて表示できてしまう
16. オープンリダイレクト脆弱性を防ぐには、リダイレクト先のドメインをチェックする
    - パラメータ改ざんによりフィッシングサイトに誘導される危険がある
    - 自サイトに飛ぶことを想定している場合は改ざんされていないことを保証する必要がある
    - 外部サイトに飛ぶことが想定される場合はクッションページを採用する
17. Httpヘッダインジェクションを防ぐには、入力パラメータをそのままレスポンスヘッダに使用しない
    - 攻撃例
        - Locationヘッダを2重出力させてリダイレクト先を改ざん
        - Set-Cookieヘッダを出力させて任意のCookie値を設定。セッション固定攻撃など
        - 2重改行と偽ボディを出力
18. クッキーの不適切な利用を防ぐには、以下の3つが要点
    - 利用者に改ざんされて困る値はクッキーにしない
    - セッションIDの場合は前述の通り
    - 可能ならばすべてのクッキーにsecure属性を付与
19. メールヘッダ・インジェクションを防ぐには、ライブラリを使いさらに注意する
    - PHPMailerならSenderに脆弱性があるため外部パラメータを設定しない
20. ディレクトリ・トラバーサルを防ぐには、以下のいずれかを実施する
    - サーバ上のファイル名を直接公開せず指定もさせない
    - 許可するファイル名を英数字のみにして制御文字やスペースなどを許容しない
21. 意図しないファイル公開を防ぐには、公開ディレクトリの仕様を理解する
    - 公開ディレクトリ（DocumentRoot）がどこかを把握する
22. OSコマンド・インジェクションを防ぐには、シェル実行用の関数を利用しない
    - php：system()、pctrl_exec()
23. スクリプトファイル・アップロードを防ぐには、公開ディレクトリをアップロード先にしない
    - アップロードファイルのアップロード先は非公開ディレクトリが鉄則
24. ファイルダウンロード・XSSを防ぐには、以下の2つを必須対処する
    - Content-Typeの適切な指定
    - X-Content-Type-Options:nosniffを付与
25. PDF FormCalc問題を防ぐには、PDFをブラウザで直接閲覧させない
    - 主にEdgeで発生
26. ファイルインクルード攻撃を防ぐには、インクルード相当操作で動的にインクルードしない
    - php:require_once()など
27. evalインジェクションを防ぐには、eval相当機能を使わない
    - evalは何かと問題になる
28. その他
    - 安全でないデシリアライゼーション
    - XXE
    - Javaサーブレット事故
    - キャッシュ事故
29. Web API設計
    - Jsonエスケープの不備
    - Json直接閲覧XSS
    - JsonpコールバックXSS
    - Web API CSRF
    - Jsonハイジャック
    - Jsonpの不適切な利用
    - CORSの検証不備

________________________________________
## 2. 脆弱性対策詳細
________________________________________
### 2.1. XSS対策

1. 入力値検証（保険）
    1. 入力文字コードの検証
    2. 入力文字コードの変換
    3. 入力値の検証
        - ヌルバイトチェック
        - 制御文字チェック
        - 文字数チェック
        - 数値に対する最大値・最小値チェック
        - 可能な限りバイナリセーフな関数を使用
2. 表示処理検証（メイン）
    - 表示パラメータをエスケープまたは検証する
        - url表示             ：url検証
        - イベントハンドラ    ：jsエスケープかつhtmlエスケープ
        - スクリプト内リテラル：jsエスケープかつhtmlエスケープ
        - url以外             ：htmlエスケープ
    - htmlを動的パラメータしたい場合
        - 必ずライブラリを使用する

htmlエスケープ

```text
<, &, " を文字参照に
phpなら、htmlspecialchars($src, ENT_QUOTES, "UTF-8")
```

jsエスケープ

```text
\, ", ', 改行 を\エスケープ
phpなら、自作関数するか、json_encode($array, JSON_HEX_TAX | JSON_HEX_AMP)
```

________________________________________
### 2.2. SQLインジェクション対策

公式のプレースホルダを利用せよ

* 別件：LIKE句にヒットするために、_と%はエスケープ必要かも

________________________________________
### 2.3. CSRF対策

フレームワークのcsrf_token機能を有効にするページを規定する

* ワンタイム値の保存先がsecure & httponlyキャッシュとセッションの2パターンがある

________________________________________
### 2.4. クリックジャッキング対策

X-Frame-Options: SAMEORIGIN

________________________________________
### 2.5. セッション管理対策

1. URLにセッションidは埋め込まない
2. セッションidは予測不能になる様に、各言語やフレームワークでSALT付与ハッシュなどする
3. ログイン認証完了時に、セッションidを再発行する
    - 別案：認証完了時に、セッションidとは別にトークンを発行する
4. セッションidのクッキーは以下にする
    - domainを指定しない
    - secure属性をつける
    - httponly属性をつける

________________________________________
## 3. セキュリティに関わる実装
________________________________________
以下については、下記書籍を参考にしてください

体系的に学ぶ 安全なWebアプリケーションの作り方 第2版 2刷  
https://www.sbcr.jp/products/4797393163.html

1. 実装と利用
   1. 認証
   2. アカウント管理
   3. 認可
   4. ログ出力
   5. 文字コード
2. 脆弱性診断のやり方